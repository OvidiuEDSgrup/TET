SELECT
--REPLACE((SELECT CONVERT(varchar,t.Cantitate)+' la '+LTRIM(RTRIM(CONVERT(CHAR,t.Termen,103)))+' ' AS [data()] FROM Termene t WHERE MAX(pozcon.Subunitate)=t.Subunitate AND MAX(pozcon.Tip)=t.Tip AND MAX(pozcon.Data)=t.Data and MAX(pozcon.Tert)=t.Tert and MAX(pozcon.Contract)=t.Contract and MAX(pozcon.Cod)=t.Cod ORDER BY t.Termen FOR XML PATH('')),'  ',' (+) ')
REPLACE((SELECT CASE WHEN exists (select 1 from termene n where n.Subunitate=t.Subunitate and n.Tip=t.Tip and n.Contract=t.Contract and n.Tert=t.Tert and n.Cod=t.Cod and n.Explicatii not like '%stoc%') THEN CONVERT(varchar,t.Cantitate)+'-'ELSE '' END+LTRIM(RTRIM(CONVERT(VARCHAR,t.Termen,103))) AS [data()] FROM Termene t WHERE pozcon.Subunitate=t.Subunitate AND pozcon.Tip=t.Tip and pozcon.Tert=t.Tert and pozcon.Contract=t.Contract and pozcon.Cod=t.Cod ORDER BY t.Termen FOR XML PATH('')),' ','+')
FROM avnefac JOIN con ON avnefac.subunitate=con.subunitate and avnefac.tip=con.tip and avnefac.contractul=con.contract and avnefac.cod_tert=con.tert and avnefac.data=con.data JOIN yso.pozconexp pozcon ON pozcon.subunitate=con.subunitate and pozcon.tip=con.tip and pozcon.contract=con.contract and pozcon.data=con.data and pozcon.tert=con.tert LEFT JOIN terti ON terti.subunitate=con.subunitate and terti.tert=con.tert LEFT JOIN nomencl ON nomencl.cod=pozcon.cod and nomencl.cod=pozcon.cod LEFT JOIN par ON par.Tip_parametru='GE' AND par.Parametru='REZSTOCBK'
GROUP BY pozcon.Subunitate, pozcon.tip, pozcon.Contract, pozcon.data, pozcon.Tert, pozcon.cod,con.loc_de_munca,pozcon.factura