EXEC yso_predariPachete '3068'
SELECT * FROM yso.predariPacheteTmp pp WHERE PP.Terminal='3068'
SELECT MAX(PD.COD),MAX(PP.Cod_intrare),'!$MG_NUME$!' as C001, '' as C002, max(ltrim(rtrim(con.explicatii))) as C003, max(rtrim(con.contract)) as C004, CASE max(doc.gestiune_primitoare) when '' then '' ELSE isnull(rtrim(ISNULL((select max(oras) from localitati where cod_oras=max(infotert.pers_contact)),max(infotert.pers_contact)))+','+rtrim(ltrim(max(e_mail)))+', jud. '+ltrim(ISNULL((select max(denumire) from judete where cod_judet=max(infotert.telefon_fax2)),max(infotert.telefon_fax2))),rtrim(isnull((select max(l.oras) from localitati l where max(terti.localitate) = l.cod_oras),max(terti.localitate)))+','+max(LTRIM(LEFT(terti.adresa,20)))) END as C005, max(LTRIM(LEFT(terti.ADRESA,50))) as C006, convert(char(18),convert(money,round(sum(pd.cantitate*pd.pret_vanzare),2)),1) as C007, RTRIM(max(nomencl.um)) as C008, MAX(ISNULL(NULLIF(PP.COD_INTRARE,pd.COD),'')) as C009, convert(char(13),convert(money,round(max(pd.pret_vanzare),2)),1) as C010, 'INCREMENT' as C011, isnull(nullif(MAX(pd.LOCATIE),''),(select max(s.locatie) from stoclim s where s.Data='2999-12-31' and s.subunitate='1' and s.cod_gestiune=max(pd.gestiune) and s.cod=max(pd.cod))) as C012, MAX(pd.GESTIUNE) as C013, max(RTRIM(LTRIM(nomencl.denumire))) as C014, ISNULL((select ltrim(rtrim(max(cod_de_bare))) from codbare c where c.cod_produs= pd.cod)+',','')+ltrim(rtrim(max(pd.cod_intrare))) as C015, MAX(pd.COD) as C016, convert(char(10),convert(money,round(sum(pd.cantitate),3)),1) as C017, MAX(rtrim(pd.LOC_DE_MUNCA)+' - '+rtrim(lm.denumire)) as C018, (SELECT max(substring(ANEXADOC.OBSERVATII,1,50)) FROM ANEXADOC where anexadoc.subunitate=avnefac.subunitate and anexadoc.tip=avnefac.tip and anexadoc.numar=avnefac.numar and anexadoc.data=avnefac.data) as C019, (select val_alfanumerica from par where tip_parametru='ID' and parametru=rtrim(host_id())+'N') as C020, '' as C021, 'FORMXML(AVIZ-Tran)' as C022,'' AS C023,'' AS C024,'' AS C025,'' AS C026,'' AS C027,'' AS C028,'' AS C029,'' AS C030,'' AS C031,'' AS C032,'' AS C033,'' AS C034,'' AS C035,'' AS C036,'' AS C037,'' AS C038,'' AS C039,'' AS C040,'' AS C041,'' AS C042,'' AS C043,'' AS C044,'' AS C045,'' AS C046,'' AS C047,'' AS C048,'' AS C049,'' AS C050,'' AS C051,'' AS C052,'' AS C053,'' AS C054,'' AS C055,'' AS C056,'' AS C057,'' AS C058,'' AS C059,'' AS C060,'' AS C061,'' AS C062,'' AS C063,'' AS C064,'' AS C065,'' AS C066,'' AS C067,'' AS C068,'' AS C069,'' AS C070,'' AS C071,'' AS C072,'' AS C073,'' AS C074,'' AS C075,'' AS C076,'' AS C077,'' AS C078,'' AS C079,'' AS C080,'' AS C081,'' AS C082,'' AS C083,'' AS C084,'' AS C085,'' AS C086,'' AS C087,'' AS C088,'' AS C089,'' AS C090,'' AS C091,'' AS C092,'' AS C093,'' AS C094,'' AS C095,'' AS C096,'' AS C097,'' AS C098,'' AS C099,'' AS C100 
FROM pozdoc pd JOIN yso.predariPacheteTmp pp ON pp.Subunitate=pd.Subunitate AND pp.tip=pd.tip AND pp.Numar=pd.Numar AND pp.Data=pd.Data and pp.numar_pozitie=pd.numar_pozitie JOIN avnefac ON avnefac.Terminal=pp.Terminal AND avnefac.Subunitate=pd.Subunitate AND avnefac.Tip=pp.tipaviz AND avnefac.Data=pp.DataAviz AND avnefac.Numar=pp.NumarAviz JOIN nomencl ON nomencl.Cod=pd.Cod LEFT JOIN con on con.Subunitate=pd.Subunitate and con.Tip='BK' and con.Contract=pp.Contract and con.tert=pp.tert LEFT JOIN pozcon on pozcon.Subunitate=con.Subunitate and pozcon.Tip=con.Tip and pozcon.Contract=con.Contract and pozcon.Tert=pp.Tert and pozcon.Cod=pp.CodPachet LEFT JOIN lm on pd.Loc_de_munca=lm.cod LEFT JOIN TERTI ON PP.TERT=TERTI.TERT LEFT JOIN DOC ON pd.NUMAR=Doc.NUMAR and doc.Tip=pd.tip and pd.data=doc.data LEFT JOIN INFOTERT on pp.subunitate=infotert.subunitate and pp.tert=infotert.tert and infotert.Identificator=con.Punct_livrare LEFT JOIN GESTIUNI ON pd.GESTIUNE_PRIMITOARE=GESTIUNI.COD_GESTIUNE WHERE avnefac.tip='TE' /*and avnefac.cod_gestiune=pd.gestiune*/ and pp.cantitate>0 AND AVNEFAC.TERMINAL='3068' GROUP BY avnefac.subunitate,avnefac.tip,avnefac.numar,avnefac.data, pd.barcod, pd.cod, pd.pret_vanzare, pd.pret_valuta, avnefac.cod_gestiune,terti.denumire  ORDER BY  isnull(nullif(MAX(pd.LOCATIE),''),(select max(s.locatie) from stoclim s where s.Data='2999-12-31' and s.subunitate='1' and s.cod_gestiune=max(pd.gestiune) and s.cod=max(pd.cod)))