set transaction isolation level read uncommitted 
select p.Listare,*--rtrim((select val_alfanumerica as nume from par where tip_parametru='GE' and parametru='NUME')) as [UNITATE], rtrim((select val_alfanumerica as cif from par where tip_parametru = 'GE' and parametru = 'CODFISC')) as [CUI], rtrim((select val_alfanumerica from par where tip_parametru = 'GE' and parametru = 'ORDREG')) as [ORDREG], rtrim((select val_alfanumerica from par where tip_parametru='GE' and parametru = 'ADRESA')) as [ADR], rtrim((select val_alfanumerica from par where tip_parametru='GE' and parametru = 'CONTBC')) as [CONT], rtrim((select val_alfanumerica from par where tip_parametru='GE' and parametru = 'BANCA')) as [BANCA], rtrim(ltrim(max(con.contract))) as [NUMAR], rtrim(max(terti.cod_fiscal)) as [CODFISC], rtrim(max(terti.judet)) as [JUDETTERT], rtrim(max(terti.localitate)) as [LOCTERT], rtrim(max(terti.banca)) as [BANCATERT], rtrim(max(terti.cont_in_banca)) as [CONTTERT], rtrim(max(terti.denumire)) as [TERT], rtrim(max(terti.adresa)) as [ADRESATERT], rtrim(max(convert(char(12),con.data,104))) as [DATA], rtrim(ltrim(max(con.contract))) as [COMANDA], rtrim(rtrim(max(con.valuta))) as [VALUTA], rtrim((Select max(gestiuni.denumire_gestiune) from gestiuni where gestiuni.cod_gestiune=max(con.gestiune))) as [PCLUCRU], rtrim(ltrim(rtrim(CASE max(p.valuta) WHEN '' THEN '' ELSE convert(char(16),convert(money,MAX(CON.CURS))) END))) as [CURS], rtrim(ROW_NUMBER() OVER(ORDER BY MIN(P.NUMAR_POZITIE))) as [NR], rtrim(left(convert(char(16),convert(money,round(max(p.Suma_TVA),2)),2),15)) as [TVALINIE], rtrim((case when max(p.tip)='FC' and exists (select codfurn from ppreturi where p.cod=ppreturi.cod_resursa and max(p.tert)=ppreturi.tert) then (select codfurn from ppreturi where p.cod=ppreturi.cod_resursa and max(p.tert)=ppreturi.tert) else p.cod end)) as [COD], rtrim(left(convert(char(16),convert(money,round(max(p.discount),2)),2),15)) as [DISC], rtrim(max(rtrim(ltrim(nomencl.cod)))+'-'+ max(rtrim(ltrim(nomencl.denumire)))) as [DENUMIRE], rtrim(max(nomencl.um)) as [UM], rtrim(left(convert(char(16),convert(money,round(sum(p.cantitate),2)),2),15)) as [CANT], rtrim(left(convert(char(16),convert(money,round(max(convert(decimal(17,5),p.pret)),2)),2),15)) as [PRETBAZA], rtrim(left(convert(char(16),convert(money,round(max(p.pret*(1-p.Discount/100.00)),2)),2),15)) as [PRETDISCUNU], rtrim(left(convert(char(16),convert(money,round(max(p.pret*(1-p.Discount/100.00)*(1-p.DiscDoi/100.00)),2)),2),15)) as [PRETDISCDOI], rtrim(convert(char(16),convert(money,max(p.pretdisc)),1)) as [PRET], rtrim(left(convert(char(16),convert(money,round(sum(p.cantitate*p.pretdisc),2))),16)) as [TOTAL], rtrim(convert(char(15),convert(money,max(p.valdisc)),1)) as [DISCPOZ], rtrim(convert(char(16),convert(money,max(p.valcutva)),1)) as [TOTALCTVA], rtrim(convert(char(15),convert(money,sum(sum(round(p.valcudisc*(con.val_reziduala/100),2))) over(partition by p.contract)),1)) as [AVANS], rtrim( (select Max(Nume) from utilizatori where ID= max(p.utilizator))) as [DELEGAT], rtrim( (select rtrim(Max(valoare)) from proprietati where TIP='UTILIZATOR' and cod_proprietate='EMAIL' and cod= max(p.utilizator))) as [EMAIL], rtrim(convert(char(15),convert(money,sum(sum(p.valdisc)) over(partition by p.contract)),1)) as [DISCTOT], rtrim(convert(char(16),convert(money,sum(sum(p.valfrtva)) over(partition by p.contract)),1)) as [TOTRONFARATVA], rtrim(convert(char(16),convert(money,sum(sum(p.valtva)) over(partition by p.contract)),1)) as [TOTRONTVA], rtrim(convert(char(16),convert(money,sum(sum(p.valcutva)) over(partition by p.contract)),1)) as [TOTRONCUTVA]
 --into ##raspASIS 
FROM avnefac 
JOIN con ON avnefac.subunitate=con.subunitate and avnefac.tip=con.tip and avnefac.contractul=con.contract and avnefac.cod_tert=con.tert and avnefac.data=con.data 
JOIN yso.pozconexp p ON p.subunitate=con.subunitate and p.tip=con.tip and p.contract=con.contract and p.data=con.data and p.tert=con.tert 
LEFT JOIN terti ON terti.subunitate=con.subunitate and terti.tert=con.tert 
LEFT JOIN nomencl ON nomencl.cod=p.cod
WHERE --p.Listare=''
avnefac.terminal='ASIS' 
--GROUP BY avnefac.tip, avnefac.numar, avnefac.data, p.cod,con.loc_de_munca, P.TERT, TERTI.TERT, p.CONTRACT ORDER BY min(p.numar_pozitie) 
--set @maxrand = isnull((select count(*) from ##raspASIS),0)
SELECT * FROM AVNEFAC where Terminal='ASIS'
select * from pozcon p where p.Contract='9890070             '