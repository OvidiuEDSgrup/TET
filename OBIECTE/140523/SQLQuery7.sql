set transaction isolation level read uncommitted 
select max(pozdoc.contract),
rtrim(isnull((select top 1 pc.detalii.value('(/row/@deviz)[1]','varchar(50)') from pozcon pc where pc.subunitate=pozdoc.subunitate and pc.tip='BK' and pc.tert=max(pozdoc.tert) and pc.contract=max(pozdoc.contract) and pc.cod=pozdoc.cod),'')) as [DEVIZ],
rtrim(MAX(POZDOC.CONTRACT)) as [COMANDA], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='NUME')) as [NUME], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='ORDREG')) as [ORDREG], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='CODFISC')) as [CODFISC], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='CAPITALS')) as [CAPITALS], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='SEDIU')) as [SEDIU], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='ADRESA')) as [ADRESA], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='JUDET')) as [JUDET], rtrim(CASE max(doc.Gestiune_primitoare) WHEN '' THEN max(terti.denumire) ELSE ISNULL( NULLIF((select max( descriere) from infotert i where i.subunitate=max(terti.subunitate) and i.tert=max(terti.tert) and i.identificator= max(ltrim(doc.Gestiune_primitoare))),''), max(terti.denumire))  END) as [TERT1], rtrim(max(terti.denumire)) as [TERT], rtrim(CASE max(doc.gestiune_primitoare) WHEN '' THEN rtrim(isnull((select max(localitati.oras) from localitati where max(terti.localitate) = localitati.cod_oras),max(terti.localitate)))+','+max((terti.adresa)) ELSE '' END) as [ADRSED], rtrim(CASE max(doc.gestiune_primitoare) when '' then '' ELSE isnull(rtrim(ISNULL((select max(oras) from localitati where cod_oras=max(infotert.pers_contact)),max(infotert.pers_contact)))+','+rtrim(ltrim(max(e_mail)))+', jud. '+ltrim(ISNULL((select max(denumire) from judete where cod_judet=max(infotert.telefon_fax2)),max(infotert.telefon_fax2))),rtrim(isnull((select max(l.oras) from localitati l where max(terti.localitate) = l.cod_oras),max(terti.localitate)))+','+max(terti.adresa)) END) as [ADRPCL], rtrim(isnull((select max(observatii) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=''), '')) as [FURNIZ], rtrim(isnull((select max(banca3) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=''), '')) as [ORCC], rtrim(max(terti.cod_fiscal)) as [CODFISCT], rtrim((Select max(gestiuni.denumire_gestiune) from gestiuni where gestiuni.cod_gestiune=max(pozdoc.gestiune))) as [PCLUCRU], rtrim(rtrim(isnull((select max(localitati.oras) from localitati where max(terti.localitate) = localitati.cod_oras),max(terti.localitate)))+','+max(terti.adresa)) as [ADRESAT], rtrim((select max(judete.denumire) from judete where max(terti.judet) = judete.cod_judet)) as [JUDETT], rtrim(max(doc.numar)) as [FACTURA], rtrim(max(terti.cont_in_banca)) as [CONTT], rtrim(max(convert(CHAR(10),pozdoc.data_facturii,103))) as [DATA], rtrim(isnull((select top 1 b.denumire from bancibnr b where b.cod=max(terti.banca)),max(terti.banca))) as [BANCAT], rtrim(MAX(pozDOC.factura)) as [AVIZ], rtrim(max(pozdoc.cota_tva)) as [PROCTVA], rtrim((select MAX(VALUTA.DENUMIRE_VALUTA) from valuta,pozdoc where pozdoc.valuta=valuta.valuta)) as [VALUTA], rtrim(convert(char(16),convert(money,max(pozdoc.CURS),2),2)) as [CURS], rtrim(ROW_NUMBER() OVER(ORDER BY MIN(pozdoc.numar_pozitie))) as [NUMARRAND], rtrim(ROW_NUMBER() OVER(ORDER BY MIN(pozdoc.numar_pozitie))) as [NRCRT], rtrim(rtrim(ltrim((case when max(nomencl.tip)='F' then (select max(denumire) from mfix where subunitate<>'DENS' and numar_de_inventar=max(pozdoc.cod_intrare)) when max(pozdoc.barcod)='' or 1=1 then max(RTRIM(nomencl.cod)+'-'+LTRIM(nomencl.denumire)) else (select max(RTRIM(ns.cod_special)+'-'+LTRIM(ns.denumire)) from nomspec ns where max(pozdoc.barcod)=ns.cod_special and pozdoc.cod=ns.cod and max(pozdoc.tert)=ns.tert) end)))) as [DEN], rtrim((select max(comanda) from stocuri s where s.subunitate=max(pozdoc.subunitate) and s.cod_gestiune=max(pozdoc.gestiune) and cod=max(pozdoc.cod) and cod_intrare=max(pozdoc.cod_intrare))) as [LOT], rtrim(max(nomencl.um)) as [UM], rtrim(convert(char(10),convert(money,round(sum(pozdoc.cantitate),3)),1)) as [CANT], rtrim(convert(char(13),convert(money,round(max(pozdoc.pret_vanzare),2)),1)) as [PRET], rtrim(max(pozdoc.discount)) as [DISC], rtrim(convert(char(20),convert(money,round(sum(pozdoc.cantitate*pozdoc.pret_vanzare),2)),1)) as [VAL], rtrim(convert(char(19),convert(money,round(sum(pozdoc.cantitate*pozdoc.pret_vanzare*pozdoc.cota_tva/100),2)),1)) as [TVA], rtrim(ISNULL((select ltrim(rtrim(max(cod_de_bare))) from codbare c where c.cod_produs= pozdoc.cod),'')) as [CODBARE]

, rtrim(max(substring(ANEXAFAC.OBSERVATII,1,50))) as [OBSERVATII], rtrim(LTRIM(convert(char(15),convert(money,round((select sum(CASE WHEN pd.cantitate<=0 THEN 0 ELSE pd.cantitate END* nc.greutate_specifica) from pozdoc pd join nomencl nc on pd.cod = nc.cod where pd.numar = max(pozdoc.numar) and pd.subunitate = max(pozdoc.subunitate) and pd.tip = max(pozdoc.tip)),2)),1))) as [GRNETA], rtrim(max(CONVERT(CHAR(10),pozdoc.data_scadentei,103))) as [SCADENTA], rtrim((select val_alfanumerica from par where tip_parametru='ID' and parametru=rtrim(host_id())+'N')) as [ION], rtrim((case when (select sum(p.discount) from pozdoc p, avnefac av where av.terminal=max(avnefac.terminal) and p.subunitate=av.subunitate and p.tip=av.tip and p.numar=av.numar and av.data=p.data)>0 then 'Total fara disc.' else '' end)) as [DISC1], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,round((select sum(p.cantitate*p.pret_valuta) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [VALFDISC], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,round((select sum(p.cantitate*p.pret_valuta*p.cota_tva/100) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [TVAFDISC], rtrim((select left(val_alfanumerica,13) from par where tip_parametru='ID' and parametru=rtrim(host_id())+'C')) as [CNP], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,-1*round((select sum(p.cantitate*(p.pret_valuta-p.pret_vanzare)) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [VALDISC], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,-round((select sum(p.cantitate*p.pret_valuta*p.cota_tva/100-p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [TVADISC], rtrim(convert(char(15),convert(money,round((select sum(round(convert(decimal(17,5),p.cantitate*p.pret_vanzare),2 )) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data) /*and av.cod_gestiune=p.gestiune*/),2)),1)) as [TOTAL], rtrim(max(CONVERT(CHAR(10), DOC.DATA_SCADENTEI ,103))) as [DATASCAD], rtrim(convert(char(15),convert(money,round((select sum(p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)/*and av.cod_gestiune=p.gestiune*/),2)),1)) as [TVATOTAL], rtrim(max(anexafac.numele_delegatului)) as [DELEG], rtrim(max(anexafac.seria_buletin)) as [CIS], rtrim(MAX(anexafac.numar_buletin)) as [CI], rtrim(max(anexafac.eliberat)) as [POLITIA], rtrim(isnull(nullif((select max(mijloc_tp) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=max(doc.gestiune_primitoare)),''),max(anexafac.mijloc_de_transport))) as [AUTO], rtrim(rtrim(max(anexafac.Numarul_mijlocului))+' '+rtrim(max(anexafac.Mijloc_de_transport))) as [NRAUTO], rtrim(convert(char(15),convert(money,(select sum(round(convert(decimal(17,5),p.cantitate*p.pret_vanzare),2 )+p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)/*and av.cod_gestiune=p.gestiune*/)),1)) as [TOTALTVA], rtrim(max(CONVERT(CHAR(10),anexafac.data_expedierii,103))) as [DATAE], rtrim(left(max(anexafac.ora_expedierii),2)+':'+substring(max(anexafac.ora_expedierii),3,2)) as [ORA], rtrim(max(isnull(doc.detalii.value('(/row/@modPlata)[1]','varchar(50)'),''))) as [MODPLATA]
 --into ##raspASIS 
FROM pozdoc left join avnefac on pozdoc.subunitate=avnefac.subunitate and pozdoc.tip=avnefac.tip and pozdoc.numar=avnefac.numar and avnefac.data=pozdoc.data left join doc on pozdoc.subunitate=doc.subunitate and pozdoc.tip=doc.tip and pozdoc.numar=doc.numar and pozdoc.data=doc.data left join terti on pozdoc.subunitate=terti.subunitate and pozdoc.tert=terti.tert left join infotert on pozdoc.subunitate=infotert.subunitate and pozdoc.tert=infotert.tert and doc.Gestiune_primitoare=infotert.identificator left join nomencl on pozdoc.cod=nomencl.cod left join anexafac on anexafac.subunitate=pozdoc.subunitate and anexafac.numar_factura=pozdoc.factura left join gestiuni on pozdoc.gestiune=gestiuni.cod_gestiune
WHERE ''=''
and avnefac.terminal='ASIS' 
GROUP BY  pozdoc.subunitate, pozdoc.cod, pozdoc.pret_vanzare, pozdoc.pret_valuta, avnefac.cod_gestiune, pozdoc.tert, pozdoc.numar, pozdoc.data ORDER BY  MIN(pozdoc.Numar_pozitie) 
--set @maxrand = isnull((select count(*) from ##raspASIS),0)