set transaction isolation level read uncommitted 
select rtrim(MAX(POZDOC.CONTRACT)) as [COMANDA], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='NUME')) as [NUME], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='ORDREG')) as [ORDREG], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='CODFISC')) as [CODFISC], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='CAPITALS')) as [CAPITALS], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='SEDIU')) as [SEDIU], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='ADRESA')) as [ADRESA], rtrim((SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='JUDET')) as [JUDET], rtrim(/*max(RTRIM(pozdoc.comanda))+' - '+(select comenzi.descriere from comenzi  where pozdoc.comanda=comenzi.comanda)*/ max(terti.denumire)) as [TERT], rtrim(max(doc.Gestiune_primitoare)+(select gestiuni.denumire_gestiune from gestiuni where pozdoc.gestiune=gestiuni.cod_gestiune)) as [TERT1], rtrim(ltrim(rtrim((select gestiuni.denumire_gestiune from gestiuni where pozdoc.gestiune=gestiuni.cod_gestiune)))) as [PRED], rtrim(ltrim(rtrim((select gestiuni.denumire_gestiune from gestiuni where max(pozdoc.gestiune_primitoare)=gestiuni.cod_gestiune)))) as [PRIM], rtrim(ltrim(rtrim(max(terti.adresa)))) as [ADRSED], rtrim('') as [ADRPCL], rtrim('') as [FURNIZ], rtrim(isnull((select max(banca3) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=''), '')) as [ORCC], rtrim(ltrim(rtrim(max(terti.cod_fiscal)))) as [CODFISCT], rtrim(max(terti.adresa)) as [ADRESAT], rtrim((Select max(gestiuni.denumire_gestiune) from gestiuni where gestiuni.cod_gestiune=max(pozdoc.gestiune))) as [PCLUCRU], rtrim((select max(judete.denumire) from judete where max(terti.judet) = judete.cod_judet)) as [JUDETT], rtrim(max(pozdoc.factura)) as [FACTURA], rtrim(max(terti.cont_in_banca)) as [CONTT], rtrim(max(convert(CHAR(10),pozdoc.data_facturii,103))) as [DATA], rtrim(max(terti.banca)) as [BANCAT], rtrim(MAX(DOC.NUMAR)) as [AVIZ], rtrim(max(pozdoc.cota_tva)) as [PROCTVA], rtrim((select VALUTA.DENUMIRE_VALUTA from valuta where pozdoc.valuta=valuta.valuta)) as [VALUTA], rtrim(convert(money,round(max(pozdoc.CURS),2))) as [CURS], rtrim(ROW_NUMBER() OVER(ORDER BY pozdoc.numar_pozitie)) as [NRCRT], rtrim(REPLACE(REPLACE(max(nomencl.denumire),'¾”','3/4'),'°','gr')) as [DEN], rtrim((select max(comanda) from stocuri s where s.subunitate=max(pozdoc.subunitate) and s.cod_gestiune=max(pozdoc.gestiune) and cod=max(pozdoc.cod) and cod_intrare=max(pozdoc.cod_intrare))) as [LOT], rtrim(max(nomencl.um)) as [UM], rtrim(convert(char(10),convert(money,round(sum(pozdoc.cantitate),3)),1)) as [CANT], rtrim(convert(char(13),convert(money,round(max(pozdoc.pret_cu_amanuntul),2)),1)) as [PRET], rtrim(max(pozdoc.discount)) as [DISC], rtrim(convert(char(20),convert(money,round(sum(pozdoc.cantitate*pozdoc.pret_cu_amanuntul),2)),1)) as [VAL], rtrim(convert(char(19),convert(money,round(sum(pozdoc.cantitate*pozdoc.pret_valuta*pozdoc.cota_tva/100),2)),1)) as [TVA], rtrim('') as [CODBARE], rtrim(max(substring(ANEXADOC.observatii,1,50))) as [OBSERVATII], rtrim(LTRIM(convert(char(15),convert(money,round((select sum(CASE WHEN pd.cantitate<=0 THEN 0 ELSE pd.cantitate END* nc.greutate_specifica) from pozdoc pd join nomencl nc on pd.cod = nc.cod where pd.numar = max(pozdoc.numar) and pd.subunitate = max(pozdoc.subunitate) and pd.tip = max(pozdoc.tip)),2)),1))) as [GRNETA], rtrim(max(CONVERT(CHAR(10),pozdoc.data_scadentei,103))) as [SCADENTA], rtrim(/*(select val_alfanumerica from par where tip_parametru='ID' and parametru=rtrim(host_id())+'N')*/'') as [ION], rtrim((case when (select sum(p.discount) from pozdoc p, avnefac av where av.terminal=max(avnefac.terminal) and p.subunitate=av.subunitate and p.tip=av.tip and p.numar=av.numar and av.data=p.data)>0 then 'Total fara disc.' else '' end)) as [DISC1], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,round((select sum(p.cantitate*p.pret_cu_amanuntul) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [VALFDISC], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,round((select sum(p.cantitate*p.pret_valuta*p.cota_tva/100) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [TVAFDISC], rtrim(/*(select left(val_alfanumerica,13) from par where tip_parametru='ID' and parametru=rtrim(host_id())+'C')*/'') as [CNP], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,-1*round((select sum(p.cantitate*(p.pret_valuta-p.pret_vanzare)) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [VALDISC], rtrim((case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,-round((select sum(p.cantitate*p.pret_valuta*p.cota_tva/100-p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end)) as [TVADISC], rtrim(convert(char(15),convert(money,round((select sum(round(convert(decimal(17,5),p.cantitate*p.pret_cu_amanuntul),2 )) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data) /*and av.cod_gestiune=p.gestiune*/),2)),1)) as [TOTAL], rtrim(MAX(DOC.DATA_SCADENTEI)) as [DATASCAD], rtrim(convert(char(15),convert(money,round((select sum(p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)/*and av.cod_gestiune=p.gestiune*/),2)),1)) as [TVATOTAL], rtrim(max(anexadoc.numele_delegatului)) as [DELEG], rtrim(max(anexadoc.seria_buletin)) as [CIS], rtrim(MAX(anexadoc.numar_buletin)) as [CI], rtrim(max(anexadoc.eliberat)) as [POLITIA], rtrim(isnull(nullif((select max(mijloc_tp) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=max(doc.gestiune_primitoare)),''),max(anexadoc.mijloc_de_transport))) as [AUTO], rtrim(max(anexadoc.numarul_mijlocului)) as [NRAUTO], rtrim(convert(char(15),convert(money,(select sum(round(convert(decimal(17,5),p.cantitate*p.pret_vanzare),2 )+p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)/*and av.cod_gestiune=p.gestiune*/)),1)) as [TOTALTVA], rtrim(max(CONVERT(CHAR(10),anexadoc.data_expedierii,103))) as [DATAE], rtrim(left(max(anexadoc.ora_expedierii),2)+':'+substring(max(anexadoc.ora_expedierii),3,2)) as [ORA]
 --into ##raspASIS 
FROM pozdoc 
 left join avnefac on avnefac.subunitate=pozdoc.subunitate and avnefac.tip=pozdoc.tip and avnefac.numar=pozdoc.numar and avnefac.data=pozdoc.data 
 left join nomencl on pozdoc.cod=nomencl.cod 
 left join anexadoc on anexadoc.subunitate=avnefac.subunitate and anexadoc.tip=avnefac.tip and anexadoc.numar=avnefac.numar and anexadoc.data=avnefac.data 
 left join doc on pozdoc.numar=doc.numar and pozdoc.Tip=doc.Tip
 left join COMENZI on POZDOC.COMANDA=COMENZI.COMANDA 
 left join terti on terti.Subunitate=pozdoc.Subunitate and terti.tert=ltrim(rtrim(pozdoc.comanda))
WHERE and and pozdoc.numar=doc.numar AND POZDOC.COMANDA=COMENZI.COMANDA and terti.tert=ltrim(rtrim(pozdoc.comanda))
and avnefac.terminal='ASIS' 
GROUP BY pozdoc.numar_pozitie, pozdoc.cod, pozdoc.pret_cu_amanuntul, pozdoc.valuta,pozdoc.gestiune,POZDOC.COMANDA  ORDER BY pozdoc.numar_pozitie, pozdoc.cod