SELECT pozdoc.cod, pozdoc.pret_vanzare, pozdoc.pret_valuta/*, avnefac.cod_gestiune*/, POZDOC.VALUTA
--MAX(VALUTA.DENUMIRE_VALUTA) as C001, max(terti.denumire) as C002, CASE max(doc.Gestiune_primitoare) WHEN '' THEN max(terti.denumire) ELSE ISNULL( NULLIF((select max( descriere) from infotert i where i.subunitate=max(terti.subunitate) and i.tert=max(terti.tert) and i.identificator= max(ltrim(doc.Gestiune_primitoare))),''), max(terti.denumire))  END as C003, (SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='SEDIU') as C004, max(pozdoc.cota_tva) as C005, (SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='ORDREG') as C006, isnull((select max(banca3) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=''), '') as C007, (SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='NUME') as C008, (select max(judete.denumire) from judete where max(terti.judet) = judete.cod_judet) as C009, (SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='JUDET') as C010, isnull((select max(observatii) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=''), '') as C011, max(pozdoc.factura) as C012, max(convert(CHAR(10),pozdoc.data_facturii,103)) as C013, convert(money,round(max(pozdoc.CURS),2)) as C014, max(terti.cont_in_banca) as C015, MAX(POZDOC.CONTRACT) as C016, max(terti.cod_fiscal) as C017, (SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='CODFISC') as C018, (SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='CAPITALS') as C019, max(terti.banca) as C020, MAX(DOC.NUMAR) as C021, CASE max(doc.gestiune_primitoare) WHEN '' THEN rtrim(isnull((select max(localitati.oras) from localitati where max(terti.localitate) = localitati.cod_oras),max(terti.localitate)))+','+max(LTRIM(LEFT(terti.adresa,20))) ELSE '' END as C022, CASE max(doc.gestiune_primitoare) when '' then '' ELSE isnull(rtrim(ISNULL((select max(oras) from localitati where cod_oras=max(infotert.pers_contact)),max(infotert.pers_contact)))+','+rtrim(ltrim(max(e_mail)))+', jud. '+ltrim(ISNULL((select max(denumire) from judete where cod_judet=max(infotert.telefon_fax2)),max(infotert.telefon_fax2))),rtrim(isnull((select max(l.oras) from localitati l where max(terti.localitate) = l.cod_oras),max(terti.localitate)))+','+max(LTRIM(LEFT(terti.adresa,20)))) END as C023, rtrim(isnull((select max(localitati.oras) from localitati where max(terti.localitate) = localitati.cod_oras),max(terti.localitate)))+','+max(LTRIM(LEFT(terti.adresa,20))) as C024, (SELECT MAX(val_alfanumerica) from par where tip_parametru='GE' and parametru='ADRESA') as C025, convert(char(20),convert(money,round(sum(pozdoc.cantitate*pozdoc.pret_valuta),2)),1) as C026, max(nomencl.um) as C027, convert(char(19),convert(money,round(sum(pozdoc.cantitate*pozdoc.pret_valuta*pozdoc.cota_tva/100),2)),1) as C028, convert(char(13),convert(money,round(max(pozdoc.pret_vanzare),2)),1) as C029, 'INCREMENT' as C030, (select max(comanda) from stocuri s where s.subunitate=max(pozdoc.subunitate) and s.cod_gestiune=max(pozdoc.gestiune) and cod=max(pozdoc.cod) and cod_intrare=max(pozdoc.cod_intrare)) as C031, max(pozdoc.discount) as C032, rtrim(ltrim((case when max(nomencl.tip)='F' then (select max(denumire) from mfix where subunitate<>'DENS' and numar_de_inventar=max(pozdoc.cod_intrare)) when max(pozdoc.barcod)='' or 1=0 then max(RTRIM(nomencl.cod)+'-'+LTRIM(nomencl.denumire)) else (select max(RTRIM(ns.cod_special)+'-'+LTRIM(ns.denumire)) from nomspec ns where max(pozdoc.barcod)=ns.cod_special and pozdoc.cod=ns.cod and max(pozdoc.tert)=ns.tert) end))) as C033, ISNULL((select ltrim(rtrim(max(cod_de_bare))) from codbare c where c.cod_produs= pozdoc.cod),'') as C034, convert(char(10),convert(money,round(sum(pozdoc.cantitate),3)),1) as C035, (case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,round((select sum(p.cantitate*p.pret_valuta) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end) as C036, (case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,-1*round((select sum(p.cantitate*(p.pret_valuta-p.pret_vanzare)) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end) as C037, convert(char(15),convert(money,round((select sum(p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)/*and av.cod_gestiune=p.gestiune*/),2)),1) as C038, (case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,round((select sum(p.cantitate*p.pret_valuta*p.cota_tva/100) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end) as C039, (case when (select sum(p.discount) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data))>0 then convert(char(15),convert(money,-round((select sum(p.cantitate*p.pret_valuta*p.cota_tva/100-p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)),2)),1) else '' end) as C040, convert(char(15),convert(money,(select sum(round(convert(decimal(17,5),p.cantitate*p.pret_vanzare),2 )+p.tva_deductibil) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data)/*and av.cod_gestiune=p.gestiune*/)),1) as C041, convert(char(15),convert(money,round((select sum(round(convert(decimal(17,5),p.cantitate*p.pret_vanzare),2 )) from pozdoc p where p.subunitate= max(pozdoc.subunitate) and p.tip= max(pozdoc.tip) and p.numar= max(pozdoc.numar) and p.data= max(pozdoc.data) /*and av.cod_gestiune=p.gestiune*/),2)),1) as C042, max(CONVERT(CHAR(10),pozdoc.data_scadentei,103)) as C043, max(anexafac.eliberat) as C044, left(max(anexafac.ora_expedierii),2)+':'+substring(max(anexafac.ora_expedierii),3,2) as C045, max(substring(ANEXAFAC.OBSERVATII,1,50)) as C046, max(anexafac.numarul_mijlocului) as C047, (select val_alfanumerica from par where tip_parametru='ID' and parametru=rtrim(host_id())+'N') as C048, LTRIM(convert(char(15),convert(money,round((select sum(CASE WHEN pd.cantitate<=0 THEN 0 ELSE pd.cantitate END* nc.greutate_specifica) from pozdoc pd join nomencl nc on pd.cod = nc.cod where pd.numar = max(pozdoc.numar) and pd.subunitate = max(pozdoc.subunitate) and pd.tip = max(pozdoc.tip)),2)),1)) as C049, (case when (select sum(p.discount) from pozdoc p, avnefac av where av.terminal=max(avnefac.terminal) and p.subunitate=av.subunitate and p.tip=av.tip and p.numar=av.numar and av.data=p.data)>0 then 'Total fara disc.' else '' end) as C050, max(anexafac.numele_delegatului) as C051, MAX(DOC.DATA_SCADENTEI) as C052, max(CONVERT(CHAR(10),anexafac.data_expedierii,103)) as C053, (select left(val_alfanumerica,13) from par where tip_parametru='ID' and parametru=rtrim(host_id())+'C') as C054, max(anexafac.seria_buletin) as C055, MAX(anexafac.numar_buletin) as C056, isnull(nullif((select max(mijloc_tp) from infotert where subunitate=max(pozdoc.subunitate) and tert=max(pozdoc.tert) and identificator=max(doc.gestiune_primitoare)),''),max(anexafac.mijloc_de_transport)) as C057, '('+rtrim(cast((select max(d.discount_p) from doc d where d.subunitate=max(pozdoc.subunitate) and d.numar=max(pozdoc.numar) and d.tip=max(pozdoc.tip) and d.data=max(pozdoc.data)) as char))+'%)' as C058,'' AS C059,'' AS C060,'' AS C061,'' AS C062,'' AS C063,'' AS C064,'' AS C065,'' AS C066,'' AS C067,'' AS C068,'' AS C069,'' AS C070,'' AS C071,'' AS C072,'' AS C073,'' AS C074,'' AS C075,'' AS C076,'' AS C077,'' AS C078,'' AS C079,'' AS C080,'' AS C081,'' AS C082,'' AS C083,'' AS C084,'' AS C085,'' AS C086,'' AS C087,'' AS C088,'' AS C089,'' AS C090,'' AS C091,'' AS C092,'' AS C093,'' AS C094,'' AS C095,'' AS C096,'' AS C097,'' AS C098,'' AS C099,'' AS C100 
FROM avnefac
,pozdoc
,nomencl
,terti
--,anexafac
--,doc
--,infotert
--,VALUTA 
WHERE pozdoc.subunitate=avnefac.subunitate and pozdoc.tip=avnefac.tip and pozdoc.numar=avnefac.numar and avnefac.data=pozdoc.data 
and pozdoc.cod=nomencl.cod 
and pozdoc.subunitate=terti.subunitate and pozdoc.tert=terti.tert 
--and anexafac.subunitate=avnefac.subunitate and anexafac.numar_factura=pozdoc.factura 
--and pozdoc.subunitate=doc.subunitate and pozdoc.tip=doc.tip and pozdoc.numar=doc.numar and pozdoc.data=doc.data 
--and pozdoc.subunitate=infotert.subunitate and pozdoc.tert=infotert.tert and doc.Gestiune_primitoare=infotert.identificator 
--AND POZDOC.VALUTA=VALUTA.VALUTA 
AND AVNEFAC.TERMINAL='4512' 
GROUP BY  pozdoc.cod, pozdoc.pret_vanzare, pozdoc.pret_valuta, /*avnefac.cod_gestiune, */POZDOC.VALUTA

--select * from avnefac
--select * from pozdoc where tip='ap' and Numar='1'